pipeline:
  agent:
    label: "any"

  environment:
    LT_USERNAME: "${LT_USERNAME}"         # Reference to Jenkins credentials (set in job or system)
    LT_ACCESS_KEY: "${LT_ACCESS_KEY}"
    PROJECT_TOKEN: "${PROJECT_TOKEN}"
    LT_SDK_DEBUG: "true"
    SMARTUI_DEBUG: "true"

  stages:
    - stage: "Checkout"
      steps:
        - checkout: "self"

    - stage: "Setup Node.js"
      steps:
        - sh: |
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
            node -v
            npm -v

    - stage: "Install Dependencies"
      steps:
        - sh: |
            npm install @lambdatest/smartui-cli @lambdatest/cypress-driver cypress@13

    - stage: "Verify Cypress Installation"
      steps:
        - sh: "npx cypress verify"

    - stage: "Create SmartUI Config"
      steps:
        - sh: "npx smartui config:create smartui-web.json"

    - stage: "Run Cypress Tests with SmartUI"
      steps:
        - sh: |
            npx smartui --version
            npx smartui --config smartui-web.json exec -- \
              npx cypress run --spec 'cypress/e2e/**/*.cy.js' --browser chrome --headless

  post:
    failure:
      - archiveArtifacts:
          artifacts: "cypress/screenshots/**"
          allowEmptyArchive: true
      - archiveArtifacts:
          artifacts: "cypress/videos/**"
          allowEmptyArchive: true
